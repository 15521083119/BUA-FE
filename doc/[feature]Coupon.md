# Coupon

## 需求分析

该环节主要是准确的需求点以便能够准确对数据库进行设计（一个人干活的悲伤）以及思考如何编写业务代码。

### 提炼功能

#### *优惠券领取

在优惠券领取页面，当用户点击领取优惠券时需要进行校验，满足如下条件才允许领取指定优惠券：

- 是否拥有领取权限（用户身份）
- 是否在活动时间范围内
- 是否存在多次领取

#### 个人中心-优惠券查看

在我的页面中，当用户点击优惠券后，需要展示如下状态的优惠券：

- 未使用
- 已过期
- 已使用

#### *核销

当用户进行订单提交时，（假设使用了优惠券）需要对优惠券进行如下核实：

- 用户是否拥有该优惠券并且状态为未使用？
- 在满足品类要求的情况下是否达到使用条件（满金额）？

> 延迟思考，订单部分在做

### 数据表设计



### RD

### 数据层（entity、repo）



#### entity

#### repo

提供两个方法：

`getStatusCoupon()` 获取指定状态的coupon

`collectCoupon( )` 用户领取优惠券

`getStatusCoupon()` 主要用于查询用户所有状态的优惠券，需要关联三张表：Coupon -> user_coupon -> user，找到user所有的coupon数据。

根据不同状态进行筛选：

  未使用（可用）：判定为未使用需要满足三个条件：status为1 以及 order为空，同时当前时间在优惠券的范围内。

  已使用：order不为空 status 2

  已过期：order 为 3 时间不在范围内。

`collectCoupon()`的逻辑拆解为如下几个步骤：

1. 判断优惠券是否为有效的
2. 判断用户是否存在重复领取
3. 创建user_coupon 存储

### 接口约定

#### 获取指定状态的优惠券

`v1/coupon/by/status/:status`

```json
req: query参数names=x,y,z

res:

```

#### 领取优惠券

`v1/coupon/collection/:couponid`

不能在http中传递用户的身份，否则会泄露用户的信息。


### service

我对service层的职责理解就是对业务进行处理后交给repo进行事务操作，而后将数据返回给controller。由于查询一组theme业务较为简单，这里直接return `repo.findByNames`即可。

### controller

我对controller层的职责理解就是主要起到承上启下作用，对上层（http网络层）主要起到解析和校验参数的工作。对下层（service层）起到业务调度和传输数据，根据不同的业务场景吊起不同的service进行业务处理，并按照约定的DTO处理`req`。

#### DTO

在定义DTO的同时，可以采用`Class-validators`对字段进行约定，便于在pipe中对参数校验处理后进行二次校验，从而保证在service层以及数据层的准确性。（毕竟操作数据层还是需要很**严谨**）。

#### pipe

在NestJS中校验工作可以交给pipe处理，在使用层面上官方已经介绍的颇为详细在此不做赘述。

功能上只需要判断简单判断前端传递过来的字符串是否合法（毕竟是query参数），校验通过后将其分割成约定好的DTO格式返回即可。

> 关于RD部分我已经将按照每篇文章的顺序进行编写，尽量在一定程度上不去贴代码，更多的是记录和分享自己的实现思考过程。
>
> 以后的每篇文章我在RD部分会贴出对应的分支，如果感兴趣的同学直接查阅源码即可。



## extra

